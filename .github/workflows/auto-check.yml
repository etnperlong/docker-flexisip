name: Auto Check Upstream

on:
  schedule:
    # Run every day at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      channels:
        type: choice
        description: 'Channels to check'
        required: false
        default: 'all'
        options:
          - all
          - stable
          - alpha
          - beta
          - edge

permissions:
  contents: write # Allow writing to repository contents (for pushing tags)
  actions: write # Allows triggering actions

env:
  GITLAB_PROJECT_ID: 'BC%2Fpublic%2Fflexisip'

jobs:
  check-versions:
    name: Check Upstream Versions
    runs-on: ubuntu-24.04
    outputs:
      build_matrix: ${{ steps.prepare.outputs.build_matrix }}
      has_builds: ${{ steps.prepare.outputs.has_builds }}
    steps:
      - name: Fetch current state from Variables
        id: current-state
        run: |
          # Read current state from repository variables
          CURRENT_STABLE="${{ vars.FLEXISIP_STABLE_VERSION }}"
          CURRENT_ALPHA="${{ vars.FLEXISIP_ALPHA_VERSION }}"
          CURRENT_BETA="${{ vars.FLEXISIP_BETA_VERSION }}"
          CURRENT_EDGE="${{ vars.FLEXISIP_EDGE_COMMIT }}"

          echo "current_stable=${CURRENT_STABLE:-}" >> $GITHUB_OUTPUT
          echo "current_alpha=${CURRENT_ALPHA:-}" >> $GITHUB_OUTPUT
          echo "current_beta=${CURRENT_BETA:-}" >> $GITHUB_OUTPUT
          echo "current_edge=${CURRENT_EDGE:-}" >> $GITHUB_OUTPUT

          echo "Current versions:"
          echo "  Stable: ${CURRENT_STABLE:-none}"
          echo "  Alpha: ${CURRENT_ALPHA:-none}"
          echo "  Beta: ${CURRENT_BETA:-none}"
          echo "  Edge: ${CURRENT_EDGE:-none}"

      - name: Fetch upstream tags and compare
        id: check
        run: |
          # Determine which channels to check
          CHANNELS="${{ inputs.channels || 'all' }}"
          echo "Requested channels: $CHANNELS"

          CHECK_STABLE=false
          CHECK_ALPHA=false
          CHECK_BETA=false
          CHECK_EDGE=false

          case "$CHANNELS" in
            "all")
              CHECK_STABLE=true
              CHECK_ALPHA=true
              CHECK_BETA=true
              CHECK_EDGE=true
              ;;
            "stable")
              CHECK_STABLE=true
              ;;
            "alpha")
              CHECK_ALPHA=true
              ;;
            "beta")
              CHECK_BETA=true
              ;;
            "edge")
              CHECK_EDGE=true
              ;;
          esac

          echo "Checking channels - stable:$CHECK_STABLE alpha:$CHECK_ALPHA beta:$CHECK_BETA edge:$CHECK_EDGE"

          # Fetch all tags from GitLab
          echo "Fetching tags from GitLab..."
          TAGS=$(curl -s "https://gitlab.linphone.org/api/v4/projects/${{ env.GITLAB_PROJECT_ID }}/repository/tags?per_page=100" | jq -r '.[].name')

          if [[ -z "$TAGS" ]]; then
            echo "Error: Failed to fetch tags from GitLab"
            exit 1
          fi

          echo "Found $(echo "$TAGS" | wc -l) tags"

          # Find latest versions for each channel
          LATEST_STABLE=""
          LATEST_ALPHA=""
          LATEST_BETA=""

          while IFS= read -r tag; do
            # Skip empty lines
            [[ -z "$tag" ]] && continue

            # Filter by channel
            if [[ "$tag" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              # Stable version (no suffix)
              if [[ -z "$LATEST_STABLE" ]] || [[ "$(printf '%s\n' "$LATEST_STABLE" "$tag" | sort -V | tail -n1)" == "$tag" ]]; then
                LATEST_STABLE="$tag"
              fi
            elif [[ "$tag" =~ -alpha ]]; then
              # Alpha version
              if [[ -z "$LATEST_ALPHA" ]] || [[ "$(printf '%s\n' "$LATEST_ALPHA" "$tag" | sort -V | tail -n1)" == "$tag" ]]; then
                LATEST_ALPHA="$tag"
              fi
            elif [[ "$tag" =~ -beta ]]; then
              # Beta version
              if [[ -z "$LATEST_BETA" ]] || [[ "$(printf '%s\n' "$LATEST_BETA" "$tag" | sort -V | tail -n1)" == "$tag" ]]; then
                LATEST_BETA="$tag"
              fi
            fi
          done <<< "$TAGS"

          echo "Latest versions found:"
          echo "  Stable: ${LATEST_STABLE:-none}"
          echo "  Alpha: ${LATEST_ALPHA:-none}"
          echo "  Beta: ${LATEST_BETA:-none}"

          # Fetch latest commit from master branch for edge
          LATEST_EDGE=""
          if [[ "$CHECK_EDGE" == "true" ]]; then
            echo "Fetching latest commit from master branch..."
            LATEST_EDGE=$(curl -s "https://gitlab.linphone.org/api/v4/projects/${{ env.GITLAB_PROJECT_ID }}/repository/branches/master" | jq -r '.commit.id')
            if [[ -z "$LATEST_EDGE" ]] || [[ "$LATEST_EDGE" == "null" ]]; then
              echo "Warning: Failed to fetch master branch commit"
              LATEST_EDGE=""
            else
              echo "  Edge (master): ${LATEST_EDGE:0:8}"
            fi
          fi

          # Set outputs
          echo "latest_stable=${LATEST_STABLE}" >> $GITHUB_OUTPUT
          echo "latest_alpha=${LATEST_ALPHA}" >> $GITHUB_OUTPUT
          echo "latest_beta=${LATEST_BETA}" >> $GITHUB_OUTPUT
          echo "latest_edge=${LATEST_EDGE}" >> $GITHUB_OUTPUT
          echo "check_stable=${CHECK_STABLE}" >> $GITHUB_OUTPUT
          echo "check_alpha=${CHECK_ALPHA}" >> $GITHUB_OUTPUT
          echo "check_beta=${CHECK_BETA}" >> $GITHUB_OUTPUT
          echo "check_edge=${CHECK_EDGE}" >> $GITHUB_OUTPUT

      - name: Prepare build matrix
        id: prepare
        run: |
          CURRENT_STABLE="${{ steps.current-state.outputs.current_stable }}"
          CURRENT_ALPHA="${{ steps.current-state.outputs.current_alpha }}"
          CURRENT_BETA="${{ steps.current-state.outputs.current_beta }}"
          CURRENT_EDGE="${{ steps.current-state.outputs.current_edge }}"

          LATEST_STABLE="${{ steps.check.outputs.latest_stable }}"
          LATEST_ALPHA="${{ steps.check.outputs.latest_alpha }}"
          LATEST_BETA="${{ steps.check.outputs.latest_beta }}"
          LATEST_EDGE="${{ steps.check.outputs.latest_edge }}"

          CHECK_STABLE="${{ steps.check.outputs.check_stable }}"
          CHECK_ALPHA="${{ steps.check.outputs.check_alpha }}"
          CHECK_BETA="${{ steps.check.outputs.check_beta }}"
          CHECK_EDGE="${{ steps.check.outputs.check_edge }}"

          # Build matrix JSON
          MATRIX_INCLUDE="[]"

          # Check stable
          if [[ "$CHECK_STABLE" == "true" ]] && [[ -n "$LATEST_STABLE" ]] && [[ "$LATEST_STABLE" != "$CURRENT_STABLE" ]]; then
            echo "âœ… Stable version needs build: $CURRENT_STABLE -> $LATEST_STABLE"
            MATRIX_INCLUDE=$(echo "$MATRIX_INCLUDE" | jq -c '. += [{"channel": "stable", "version": "'"$LATEST_STABLE"'", "tag_latest": true, "is_commit": false}]')
          fi

          # Check alpha
          if [[ "$CHECK_ALPHA" == "true" ]] && [[ -n "$LATEST_ALPHA" ]] && [[ "$LATEST_ALPHA" != "$CURRENT_ALPHA" ]]; then
            echo "âœ… Alpha version needs build: $CURRENT_ALPHA -> $LATEST_ALPHA"
            MATRIX_INCLUDE=$(echo "$MATRIX_INCLUDE" | jq -c '. += [{"channel": "alpha", "version": "'"$LATEST_ALPHA"'", "tag_latest": false, "is_commit": false}]')
          fi

          # Check beta
          if [[ "$CHECK_BETA" == "true" ]] && [[ -n "$LATEST_BETA" ]] && [[ "$LATEST_BETA" != "$CURRENT_BETA" ]]; then
            echo "âœ… Beta version needs build: $CURRENT_BETA -> $LATEST_BETA"
            MATRIX_INCLUDE=$(echo "$MATRIX_INCLUDE" | jq -c '. += [{"channel": "beta", "version": "'"$LATEST_BETA"'", "tag_latest": false, "is_commit": false}]')
          fi

          # Check edge (master branch)
          if [[ "$CHECK_EDGE" == "true" ]] && [[ -n "$LATEST_EDGE" ]] && [[ "$LATEST_EDGE" != "$CURRENT_EDGE" ]]; then
            echo "âœ… Edge version needs build: ${CURRENT_EDGE:0:8} -> ${LATEST_EDGE:0:8}"
            MATRIX_INCLUDE=$(echo "$MATRIX_INCLUDE" | jq -c '. += [{"channel": "edge", "version": "'"$LATEST_EDGE"'", "tag_latest": false, "is_commit": true}]')
          fi

          # Check if we have any builds
          BUILD_COUNT=$(echo "$MATRIX_INCLUDE" | jq 'length')
          if [[ "$BUILD_COUNT" -gt 0 ]]; then
            echo "has_builds=true" >> $GITHUB_OUTPUT
            echo "Found $BUILD_COUNT version(s) to build"
          else
            echo "has_builds=false" >> $GITHUB_OUTPUT
            echo "No new versions to build"
          fi

          # Output matrix
          MATRIX_JSON=$(jq -c -n --argjson include "$MATRIX_INCLUDE" '{"include": $include}')
          echo "build_matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "Matrix JSON:"
          echo "$MATRIX_JSON" | jq '.'

  build-versions:
    name: Build ${{ matrix.channel }} (${{ matrix.version }})
    needs: check-versions
    if: needs.check-versions.outputs.has_builds == 'true'
    strategy:
      matrix: ${{ fromJson(needs.check-versions.outputs.build_matrix) }}
      fail-fast: false
    uses: ./.github/workflows/build-docker.yml
    with:
      flexisip_version: ${{ matrix.version }}
      channel: ${{ matrix.channel }}
      tag_latest: ${{ matrix.tag_latest }}
      is_commit: ${{ matrix.is_commit }}
    secrets: inherit

  update-state:
    name: Update Build State
    needs: [check-versions, build-versions]
    if: always() && needs.check-versions.outputs.has_builds == 'true' && needs.build-versions.result == 'success'
    runs-on: ubuntu-24.04
    steps:
      - name: Update GitHub Variables
        env:
          # Use PAT with 'variables:write' permission instead of GITHUB_TOKEN
          # GITHUB_TOKEN doesn't support repository variables modification
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          # Parse matrix to get version info
          MATRIX='${{ needs.check-versions.outputs.build_matrix }}'
          echo "Processing build results..."
          echo "$MATRIX" | jq '.'

          echo "âœ… All builds completed successfully, updating variables..."

          # Update variables for each successful build
          echo "$MATRIX" | jq -r '.include[] | "\(.channel)=\(.version)"' | while IFS='=' read -r channel version; do
            case "$channel" in
              "stable")
                echo "Updating FLEXISIP_STABLE_VERSION to $version"
                gh variable set FLEXISIP_STABLE_VERSION --body "$version" --repo ${{ github.repository }}
                ;;
              "alpha")
                echo "Updating FLEXISIP_ALPHA_VERSION to $version"
                gh variable set FLEXISIP_ALPHA_VERSION --body "$version" --repo ${{ github.repository }}
                ;;
              "beta")
                echo "Updating FLEXISIP_BETA_VERSION to $version"
                gh variable set FLEXISIP_BETA_VERSION --body "$version" --repo ${{ github.repository }}
                ;;
              "edge")
                echo "Updating FLEXISIP_EDGE_COMMIT to $version"
                gh variable set FLEXISIP_EDGE_COMMIT --body "$version" --repo ${{ github.repository }}
                ;;
            esac
          done

          echo "âœ… Variables updated successfully"

  summary:
    name: Build Summary
    needs: [check-versions, build-versions, update-state]
    if: always()
    runs-on: ubuntu-24.04
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ” Upstream Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.check-versions.outputs.has_builds }}" == "true" ]]; then
            echo "### âœ… Builds Triggered" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo '${{ needs.check-versions.outputs.build_matrix }}' | jq '.' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            BUILD_RESULT="${{ needs.build-versions.result }}"
            if [[ "$BUILD_RESULT" == "success" ]]; then
              echo "### âœ… All builds completed successfully" >> $GITHUB_STEP_SUMMARY
              UPDATE_RESULT="${{ needs.update-state.result }}"
              if [[ "$UPDATE_RESULT" == "success" ]]; then
                echo "### âœ… Variables updated successfully" >> $GITHUB_STEP_SUMMARY
              else
                echo "### âš ï¸ Variable update status: $UPDATE_RESULT" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "### âš ï¸ Build status: $BUILD_RESULT" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### â„¹ï¸ No new versions to build" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All versions are up to date." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "Workflow completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
